# Flowvisor quantum plugin.

# Save trace setting
MY_XTRACE=$(set +o | grep xtrace)
set +o xtrace

source $TOP_DIR/lib/quantum_plugins/ovs_base
source $TOP_DIR/lib/quantum_thirdparty/flowvisor

function quantum_plugin_create_nova_conf() {
    NOVA_VIF_DRIVER=${NOVA_VIF_DRIVER:-"nova.virt.libvirt.vif.LibvirtGenericVIFDriver"}
    iniset $NOVA_CONF DEFAULT libvirt_ovs_integration_bridge "$OVS_BRIDGE"
}

function quantum_plugin_install_agent_packages() {
    _quantum_ovs_base_install_agent_packages
}

function quantum_plugin_configure_common() {
    Q_PLUGIN_CONF_PATH=etc/quantum/plugins/flowvisor
    Q_PLUGIN_CONF_FILENAME=flowvisor.ini
    Q_DB_NAME="flowvisor_quantum"
    Q_PLUGIN_CLASS="quantum.plugins.flowvisor.plugin.FlowvisorPluginV2"
    FV_HOST=${FV_HOST:-localhost}
    FV_JSON_RPC_PORT=${FV_JSON_RPC_PORT:-8081}
    FV_OPENFLOW_PORT=${FV_OPENFLOW_PORT:-6633}
}

function quantum_plugin_configure_debug_command() {
    _quantum_ovs_base_configure_debug_command
}

function quantum_plugin_configure_dhcp_agent() {
    _quantum_ovs_base_setup_bridge $OVS_BRIDGE
}

function quantum_plugin_configure_l3_agent() {
    _quantum_ovs_base_configure_l3_agent
}

function quantum_plugin_configure_plugin_agent() {
    :
}

function quantum_plugin_configure_service() {
    iniset $QUANTUM_CONF DEFAULT api_extensions_path \
            "quantum/plugins/flowvisor/extensions/"
    iniset /$Q_PLUGIN_CONF_FILE FLOWVISOR jrpc_url \
            "https://${FV_HOST}:${FV_JSON_RPC_PORT}"
    iniset /$Q_PLUGIN_CONF_FILE FLOWVISOR username $FV_USERNAME
    iniset /$Q_PLUGIN_CONF_FILE FLOWVISOR password $FV_PASSWORD
}

function quantum_plugin_setup_interface_driver() {
    local conf_file=$1
    iniset $conf_file DEFAULT interface_driver quantum.agent.linux.interface.OVSInterfaceDriver
    iniset $conf_file DEFAULT ovs_use_veth True
}

function has_quantum_plugin_security_group() {
    # 1 means False here
    return 1
}

function quantum_plugin_check_adv_test_requirements() {
    is_service_enabled q-agt && is_service_enabled q-dhcp && return 0
}

# Restore xtrace
$MY_XTRACE
